<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <!-- Ensure dark browser UI on mobile (Android, older Chrome) -->
  <meta name="theme-color" content="#000000">
  <!-- Mobile browser UI colors -->
  <meta name="theme-color" content="#000000" media="(max-width: 768px)">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous">
  <meta name="application-name" content="Auto Window Remote Control">
  <link rel="icon" href="/icons/favicon.svg" type="image/svg+xml">
  <title>Auto Window Remote Control</title>
  <link rel="stylesheet" href="styles.css?v=20250923-1" />
  <script src="config.js"></script>
</head>
<body>
  <div class="dashboard">
    <!-- Row 1 -->
    <div class="row row-1">
      <div class="card">
        <div class="card-header">
          <div class="status-wrap">
            <div id="mqtt-status" class="status-dot offline" aria-label="MQTT status" title="Offline"></div>
            <span id="mqtt-status-text" class="status-text">Offline</span>
          </div>
          <div class="graph-controls" id="graph-controls">
            <button class="time-btn" data-range="live">Live</button>
            <button class="time-btn" data-range="15m">15m</button>
            <button class="time-btn" data-range="30m">30m</button>
            <button class="time-btn" data-range="1h">1h</button>
            <button class="time-btn" data-range="6h">6h</button>
            <button class="time-btn" data-range="1d">1d</button>
          </div>
        </div>
        <div id="live-stale-banner" class="stale-banner" aria-live="polite" aria-atomic="true" hidden>
          <span class="msg">No new data for 5s — showing last known value</span>
          <button class="banner-close" type="button" aria-label="Dismiss">×</button>
        </div>
        <div id="bridge-banner" class="stale-banner" aria-live="polite" aria-atomic="true" hidden>
          <span class="msg">DB bridge not running, if you need to save current settings and sensor data contact Wamburu to run the bridge</span>
          <button class="banner-close" type="button" aria-label="Dismiss">×</button>
        </div>
  <div class="graph"><canvas id="th-graph"></canvas></div>
      </div>

      <div class="card">
        <div class="controls">
          <div class="control-item condition">
            <span class="label">Condition</span>
            <span class="icon">☀️</span>
          </div>
          <div class="control-item auto">
            <div class="toggle" id="auto-toggle" role="button" aria-pressed="false"></div>
            <span class="label">Auto</span>
          </div>
          <div class="control-item motion">
            <span class="label">Motion</span>
            <span class="status" id="motion-status">Calm</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2 -->
    <div class="row row-2">
      <div class="card">
        <div class="temp-humidity-container">
          <div class="temp-humidity-item">
            <h3>Temperature</h3>
            <div class="gauge temp" id="temperature-value">
              <svg width="150" height="120" viewBox="0 0 150 120">
                <g class="ring-rot">
                  <circle class="gauge-bg" cx="75" cy="60" r="50"/>
                  <circle class="gauge-progress" cx="75" cy="60" r="50"/>
                </g>
              </svg>
              <div class="gauge-value">--<sup>°C</sup></div>
            </div>
          </div>
          <div class="temp-humidity-item">
            <h3>Humidity</h3>
            <div class="gauge humidity" id="humidity-value">
              <svg width="150" height="120" viewBox="0 0 150 120">
                <g class="ring-rot">
                  <circle class="gauge-bg" cx="75" cy="60" r="50"/>
                  <circle class="gauge-progress" cx="75" cy="60" r="50"/>
                </g>
              </svg>
              <div class="gauge-value">--<sup>%</sup></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card">
        <!-- slider + small gauge + vent (center) + threshold (right) -->
        <div class="servo-container">
          <!-- left: slider + small gauge -->
          <div class="left-wrap">
            <input id="servo-slider" class="servo-slider" type="range" min="0" max="180" value="90" />
            <div class="angle-stack" style="display:flex;flex-direction:column;align-items:center;gap:8px;">
              <div class="gauge-title">° opened</div>
              <div class="gauge servo small" id="window-angle" data-interactive="true">
              <svg width="160" height="130" viewBox="0 0 160 130">
                <g class="ring-rot">
                  <!-- center shifted down to add more space on top for shadow -->
                  <circle class="gauge-bg" cx="80" cy="70" r="50"/>
                  <circle class="gauge-progress" cx="80" cy="70" r="50"/>
                  <!-- draggable knob at arc end: positioned by JS via transform -->
                  <!-- Invisible hit area for easier touch/mouse grab; follows knob via transform -->
                  <circle class="gauge-knob-hit" cx="80" cy="70" r="18" style="fill: transparent; stroke: transparent; pointer-events: all;" />
                  <circle class="gauge-knob" cx="80" cy="70" r="10" />
                </g>
              </svg>
              <div class="gauge-value">--°</div>
              </div>
            </div>
          </div>

          <!-- center: vent button -->
          <div class="vent-wrap">
            <button type="button" id="vent-btn" class="vent-btn" aria-label="Toggle Vent" aria-pressed="false">
              <svg class="fan-icon" viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                <g class="blades">
                  <ellipse cx="12" cy="5.5" rx="2.6" ry="6.8" />
                  <ellipse cx="12" cy="5.5" rx="2.6" ry="6.8" transform="rotate(120 12 12)" />
                  <ellipse cx="12" cy="5.5" rx="2.6" ry="6.8" transform="rotate(240 12 12)" />
                </g>
                <circle cx="12" cy="12" r="2.2" />
              </svg>
            </button>
          </div>

          <!-- right: threshold -->
          <div class="threshold">
            <div class="threshold-box">
              <div class="threshold-label">Open at (°C)</div>
              <div class="threshold-controls">
                <button type="button" id="th-dec">-</button>
                <span id="threshold-value">23</span>
                <button type="button" id="th-inc">+</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MQTT + logic -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Prefer injected config.js values; fallback to existing constants
    const cfg = (window.__APP_CONFIG__ || {});
    window.SUPABASE_URL = cfg.SUPABASE_URL || window.SUPABASE_URL || '';
    window.SUPABASE_ANON_KEY = cfg.SUPABASE_ANON_KEY || window.SUPABASE_ANON_KEY || '';
    window.MQTT_URL = cfg.MQTT_URL || window.MQTT_URL || 'wss://broker.hivemq.com:8884/mqtt';
    window.MQTT_USERNAME = cfg.MQTT_USERNAME || '';
    window.MQTT_PASSWORD = cfg.MQTT_PASSWORD || '';
    window.MQTT_CLIENT_ID_PREFIX = cfg.MQTT_CLIENT_ID_PREFIX || 'dashboard-';
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mqtt@5/dist/mqtt.min.js"></script>
  <script src="app.js?v=20250923-1"></script>
  
  <!-- Toast container -->
  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>
</body>
</html>
